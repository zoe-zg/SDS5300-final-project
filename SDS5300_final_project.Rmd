---
title: "Winning Formula: An Analysis of F1 Race Success (2010-2024)"
author: "Andrew Fouty, Zoe Zhang"
date: "`r Sys.Date()`"
output: html_document
---


This analysis focuses on the **modern era** (2010 - 2024) of Formula 1 racing. This period represents a distinct phase in F1 history characterized by:

- **Technical Regulations**: Introduction of hybrid power units (2014), DRS (Drag Reduction System), and increased emphasis on aerodynamics
- **Dominant Teams**: The rise of Mercedes' dominance, Red Bull's continued success, and Ferrari's competitive resurgence
- **Driver Talent**: Era featuring champions like Hamilton, Alonso, Vettel, Verstappen, and emerging stars
- **Competition Evolution**: More sophisticated data analytics and race strategy


We investigate factors that influence race performance (specifically, race finishing positions and fastest lap speed) in this modern competitive landscape. We are interested in whether race outcomes are driven more by the driver or the constructor. Specifically, we looked at

- whether the finishing positions differ significantly different between British and German drivers (Britain and Germany have the most F1 drivers)
- whether Fernando Alonso‚Äôs finishing positions differ between his career at Ferrari and Renault (Alonso has the longest career in this era and is a top performing driver)
- whether the fastest lap speed differ significantly among top constructors (i.e. Ferrari, Mercedes, McLaren, Red Bull)
- and fit a multiple linear regression model to predict the race finishing positions.



```{r setup, include=FALSE}
knitr::opts_chunk$set(
	message = FALSE,
	warning = FALSE,
	echo = FALSE
)
# load library
library(tidyverse)
library(car)
library(boot)
library(ggplot2)
library(dplyr)
library(corrplot)
library(leaps)
library(MASS)
library(lubridate)
library(PerformanceAnalytics)
```



# Data cleaning and preparation

The data comes from [Formula 1 World Championship (1950 - 2024)] (https://www.kaggle.com/datasets/rohanrao/formula-1-world-championship-1950-2020).
The dataset consists of all information on the Formula 1 races, drivers, constructors, qualifying, circuits, lap times, pit stops, championships from 1950 till the latest 2024 season. 

The observational unit of the base dataset `result` is one result for one driver in one race, we then used left join to merge the other datasets with unique identifier such as raceId, driverId, constructorId, etc.

Overall, this dataset is fairly complete in terms of missing data. The Kaggle/Ergast dataset uses the string ("\N") for missing data, so we treated the string \N in the input data as a missing value (NA), making sure numeric columns are numeric as they're supposed to. 

We filtered out pit stop records exceeding 60 seconds, as these extreme values are most likely outliers caused by race stoppages (e.g. red flags) rather than active competitive pit stops. We also excluded race finishing position larger than 20 since there are only 20 cars on the track each race.

We created a few new continuous and categorical/binary variables, including pit stop duration, driver's age at the year of race, finish on podium (Y/N), finish with points (Y/N). Not all variables were included in the final analysis and output.



```{r echo=FALSE}
# Load datasets
base_url <- "https://raw.githubusercontent.com/zoe-zg/SDS5300-final-project/main/data/"

f1_results <- read.csv(paste0(base_url, "results.csv"), na.strings = "\\N")
f1_constructor_results <- read.csv(paste0(base_url, "constructor_results.csv"), na.strings = "\\N")
f1_races <- read.csv(paste0(base_url, "races.csv"), na.strings = "\\N")
f1_drivers <- read.csv(paste0(base_url, "drivers.csv"), na.strings = "\\N")
f1_constructors <- read.csv(paste0(base_url, "constructors.csv"), na.strings = "\\N")
f1_driver_standings <- read.csv(paste0(base_url, "driver_standings.csv"), na.strings = "\\N")
f1_constructor_standings <- read.csv(paste0(base_url, "constructor_standings.csv"), na.strings = "\\N")
f1_quali <- read.csv(paste0(base_url, "qualifying.csv"), na.strings = "\\N")
f1_lap_times <- read.csv(paste0(base_url, "lap_times.csv"), na.strings = "\\N")
f1_pit_stops <- read.csv(paste0(base_url, "pit_stops.csv"), na.strings = "\\N")
# f1_status <- read.csv(paste0(base_url, "status.csv"), na.strings = "\\N")
# f1_seasons <- read.csv(paste0(base_url, "seasons.csv"), na.strings = "\\N")

f1_pit_summary <- f1_pit_stops %>% 
  group_by(raceId, driverId) %>% 
  summarize(duration = mean(milliseconds)/1000)

# Merge datasets
f1_data <- f1_results %>%  
  left_join(f1_races, by = "raceId") %>%
  left_join(f1_drivers, by = "driverId") %>%
  left_join(f1_constructors, by = "constructorId") %>% 
  left_join(f1_pit_summary, by = c("raceId", "driverId")) %>% 
  rename(driver_nationality = nationality.x, constructor_nationality = nationality.y,
         race_name = name.x, constructor_name = name.y) %>% 
  dplyr::select(raceId, year, round, driverId, circuitId, race_name, grid, positionOrder, points, positionText,
         driverRef, constructorRef, driver_nationality, constructor_nationality,
         statusId, laps, fastestLapSpeed, fastestLapTime, fastestLap, dob, milliseconds, round, duration) 

# f1_driver_standings <- f1_driver_standings %>% 
#   left_join(f1_drivers, by = "driverId")

```

Below are the dimensions of the cleaned dataframe.

```{r echo=FALSE}

# Text Character Replacement / Cleaning
f1_data <- f1_data %>% mutate(fastestLapSeconds = as.numeric(ms(fastestLapTime)))

f1_clean <- f1_data %>% 
  filter(year >= 2010) %>%
  mutate(driverRef = as.factor(driverRef),
         constructorRef = as.factor(constructorRef),
         # is_points = ifelse(positionOrder <= 10, 1, 0),
         # is_points = as.factor(is_points), 
         # did the driver finish on the podium (top 3 finish)
         # is_podium = ifelse(positionOrder <=3, 1, 0),
         # is_podium = as.factor(is_podium),
         fastestLapSpeed = as.numeric(as.character(fastestLapSpeed)),
         age = year - as.numeric(substr(dob, 1, 4)),
         # race_completion = positionText
         ) %>% 
  # missing values
  drop_na(grid, positionOrder)


n_rows <- nrow(f1_clean)    # Number of rows
n_cols <- ncol(f1_clean)    # Number of columns

# Create a new data frame to act as a summary table
dimension_summary <- data.frame(
  Dimension = c("Rows (Observations)", "Columns (Variables)"),
  Count = c(n_rows, n_cols)
)

# Print the summary table
print(dimension_summary)

```

Below are the first 6 rows of the dataframe.

```{r echo=FALSE}
head(f1_clean)
```



# üèÅ A sneak peek into the rivals

#### British vs German drivers
Here we compare the race finishing positions between British and German drivers from the two most dominant countries in F1 racing and in automobile.
By visual inspection, we can see clear mean race finishing positions between these two countries, with British drivers having a better race finishing results (finishing position lower is better).

```{r echo=FALSE}
# driver counts by country

# f1_clean %>% group_by(driver_nationality) %>% 
#   summarize(unique_drivers = n_distinct(driverRef)) %>% 
#   arrange(desc(unique_drivers))

f1_brit_german <- f1_clean %>% filter(driver_nationality %in% c("British", "German"))

boxplot(positionOrder ~ driver_nationality,
        data = f1_brit_german,
        main = "Race Finishing Position: British vs German Drivers",
        ylab = "Finishing Position",
        xlab = ""
          )
```

We then performed a two-sample t-test to examine if the difference is significant. Using an \alpha level of 0.05, the result shows that there is a statistically significant difference in the finishing position between the two groups. 

```{r echo=FALSE}
ttest_brit_german <- t.test(positionOrder ~ driver_nationality, data = f1_brit_german, conf.level = 0.95)
ttest_brit_german
```

We also performed a bootstrap test to confirm our results from the t-test. The bootstrapped CI and theoretical CI are very close and symmetrical; neither include 0. Also shown below is the Normal Q-Q plot of bootstrapped differences, normally distributed as we would anticipate.

```{r echo=FALSE}

set.seed(230) 

# FILL IN REMAINING CODE
n_samp <- 10000

diff_brit_german <- rep(NA, n_samp)

for (i in 1:n_samp) {
  brit <- sample(f1_brit_german$positionOrder[f1_brit_german$driver_nationality == "British"], 
                 sum(f1_brit_german$driver_nationality == "British"), replace = TRUE)
  german <- sample(f1_brit_german$positionOrder[f1_brit_german$driver_nationality == "German"],
                 sum(f1_brit_german$driver_nationality == "German"), replace = TRUE)
  diff_brit_german[i] <- mean(brit) - mean(german)
}

# Calculate a 95% Bootstrap confidence interval. Show your results rounded to two decimal places
ci <- quantile(diff_brit_german, c(0.025, 0.975))
# round(ci, 2)

# Histogram of bootstrap difference in means and add CI lines
hist(diff_brit_german, col = "grey", main = "Bootstrapped Sample Means Diff in Race Finishing Position", xlab = "Race Finishing Position", breaks = 50)

abline(v = ci, lwd = 3, col = "orange")
abline(v = ttest_brit_german$conf.int, lwd = 3, col = "black", lty = 2)
legend("topright", c("Theoretical CI","Bootstrap CI"), lwd = 3, col = c("black","orange"), lty = c(2,1))


# Normal Q-Q plot of bootstrapped differences
qqPlot(diff_brit_german, main = "Normal Q-Q Plot of Bootstrap Differences")


```
We also performed a permutation test to show that our results from all three tests are consistent.
This suggests that none of our 10000 simulations produced a difference that was more extreme than the actual difference in means. We see a permuted p-value of 0, suggesting that the probability of seeing this difference between groups under null hypothesis is extremely unlikely.


```{r echo=FALSE}

set.seed(230)

N <- 100000
diffvals <- rep(NA, N)

# assign countries at random to each group, compute statistic and store
for (i in 1:N) {
  shuffled_country <- sample(f1_brit_german$driver_nationality)  # default is replace = FALSE
  diffvals[i] <- as.numeric(mean(f1_brit_german$positionOrder[shuffled_country == "British"], na.rm = T) -  mean(f1_brit_german$positionOrder[shuffled_country == "German"], na.rm = T))
}

# observed difference in medians 
diff_obs <- mean(f1_brit_german$positionOrder[f1_brit_german$driver_nationality == "British"], na.rm = T) -
  mean(f1_brit_german$positionOrder[f1_brit_german$driver_nationality == "German"], na.rm = T)

# make histogram of permuted median differences
hist(diffvals, 
     main = "Permuted sample mean difference in finishing position", 
     xlab = "Finishing position",
     xlim = c(-2, 2),
     col = "lightgrey",
     breaks = 50)
abline(v = diff_obs, col = "blue", lwd = 3, lty = "dotted")
text(diff_obs - 0.2, 1500 , paste("Actual Diff in Means =", round(diff_obs,2)), srt = 90)

paste0("The permuted p-value is ",  mean(abs(diffvals) >= abs(diff_obs)), ".")

```


# üèÅ Driver or Car? 

In this section, we attampt to disentangle driver skill from machine performance. We compared Alonso's qualifying to race results across his two teams eras using side-by-side scatterplots and correlation.

#### Alonso's Perormance at Ferrari vs McLaren

To assess the impact of race car performance on driver results, we subsetted the data to isolate Fernando Alonso's career at two major contructors: Ferrari and McLaren. The boxplot below displays the distribution of his finishing positions at both teams.

Visually, there is a marked contrast between the two periods: Alonso's median finishing position was significantly lower (better) at Ferrari than that at McLaren.There is also a tighter interquartile range at Ferrari than McLaren, indicating consistent top performance with Ferrari. In contrast, his race performance at McLaren also shows increased variability, likely reflecting the constructor mechanical reliability issues during those seasons.


```{r echo= FALSE}
f1_alonso_test <- f1_clean %>% 
  filter(driverRef == "alonso", constructorRef %in% c("mclaren", "ferrari")) %>% 
  droplevels()

boxplot(positionOrder ~ constructorRef,
        data = f1_alonso_test,
        main = "Alonso Race Finishing Position with McLaren vs Ferrari",
        ylab = "Finishing Position",
        col = c("#FF2800", "#00A0DF"),
        border = "gray30",
        xlab = "")

ggplot(f1_alonso_test, aes(x = constructorRef, y = positionOrder, fill = constructorRef)) +
  geom_boxplot(alpha = 0.7, width = 0.55, outlier.shape = NA) +
  geom_jitter(width = 0.15, alpha = 0.5) +
  scale_fill_manual(values = c("ferrari" = "#FF2800", "mclaren" = "#FF9800")) +
  labs(
    title = "Fernando Alonso Finishing Positions: McLaren vs Ferrari",
    x = "",
    y = "Finishing Position"
  ) +
  theme_classic(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5),
    legend.position = "none"
  )
```

After visualizing Alonso's finishing positions at both teams, we performed a two-sample t-test to determine whether the performance difference between his time at Ferrari and McLaren is statistically significant. And the test doesn't assume equal variance.

$$H_0: There is no difference in the mean finishing position for Alonso between Ferrari and McLaren (\mu_{Ferrari} = \mu_{McLaren}) $$
$$H_A: The mean finishing positions for Alonso at Ferrari and McLaren are significantly different (\mu_{Ferrari} \neq \mu_{McLaren}) $$

The result shows a highly significant difference (p<.05) in Alonso's finishing positions between the two teams. The entire CI is well below zero, indicating that Alonso finished substantially better during his time at Ferrari compared to McLaren - a large performance difference between constructors. 


```{r echo=FALSE}

ttest_alonso <- t.test(positionOrder ~ constructorRef, data = f1_alonso_test, conf.level = 0.95)
ttest_alonso

```

After a two-sample t-test, we computed a bootstrap CI for the difference in means of finishing positions at Ferrari vs. McLaren. The histogram shows an approximately bell-shaped distribution centered around ‚Äì8 to ‚Äì7, suggesting that Alonso typically finished 7‚Äì8 places better at Ferrari than McLaren. The 95% bootstrap CI [-9.27, -6.23] closely matches the t-test interval and the CI doesn't include zero, the result strongly indicates that Alonso's performance at Ferrari was consistently and significantly better than that at McLaren.

The Q-Q plot of the bootstrap differences shows close alignment along the diagonal line with only mild deviations at the tails, suggesting the sampling distribution is Normal. Therefore, we can be confident that the results of our t-test and CI are valid and not distorted by skewness or outliers.


```{r}
set.seed(230) 

n_samp <- 10000

diff_alonso <- rep(NA, n_samp)

for (i in 1:n_samp) {
  mclaren <- sample(f1_alonso_test$positionOrder[f1_alonso_test$constructorRef == "mclaren"], 
                 sum(f1_alonso_test$constructorRef == "mclaren"), replace = TRUE)
  ferrari <- sample(f1_alonso_test$positionOrder[f1_alonso_test$constructorRef == "ferrari"],
                 sum(f1_alonso_test$constructorRef == "ferrari"), replace = TRUE)
  diff_alonso[i] <- mean(ferrari) - mean(mclaren)
}

# calculate 95% CI
ci <- quantile(diff_alonso, c(0.025, 0.975))
# round(ci, 2)

par(mfrow = c(1, 2))
# Histogram of bootstrap difference in means and add CI lines
hist(diff_alonso, col = "grey", border = "white", 
     main = "Bootstrap dist in Race Finishing Position\n(Ferrari - McLaren)", xlab = "Diff in Race Finishing Position", 
     breaks = 50)
abline(v = ci, lwd = 2, col = "darkred")
abline(v = ttest_alonso$conf.int, lwd = 2, col = "navy", lty = 2)
legend("topleft", c("Bootstrap CI", "Theoretical CI"), lwd = 2, col = c("darkred","navy"), lty = c(2,1), bty = "n", cex = 0.7)


# Normal Q-Q plot of bootstrapped differences
qqPlot(diff_alonso, 
       main = "Normal Q-Q Plot of Bootstrap Difference",
       ylab = "Bootstrap difference",
       id = FALSE,
       grid = FALSE
       )


```


The permutation test was performed with 10,000 simulations. The observed difference in mean (blue dotted line) falls outside the range of the permuted null distribution, suggesting that the probability of observing such a performance gap by random chance is effectively zero. This result corroborates our t-test and bootstrap findings; Alonso's superior performance at Ferrari compared to McLaren was statistically significant and not due to random chance.


```{r echo=FALSE}

set.seed(230)

N <- 10000
diffvals <- rep(NA, N)

# assign countries at random to each group, compute statistic and store
for (i in 1:N) {
  shuffled_team <- sample(f1_alonso_test$constructorRef)  # default is replace = FALSE
  diffvals[i] <- as.numeric(mean(f1_alonso_test$positionOrder[shuffled_team == "ferrari"], na.rm = T) -  mean(f1_alonso_test$positionOrder[shuffled_team == "mclaren"], na.rm = T))
}

# observed difference in means 
diff_obs <- mean(f1_alonso_test$positionOrder[f1_alonso_test$constructorRef == "ferrari"], na.rm = T) -
  mean(f1_alonso_test$positionOrder[f1_alonso_test$constructorRef == "mclaren"], na.rm = T)

# make histogram of permuted mean differences
hist(diffvals, 
     main = "Permuted sample mean difference in finishing position", 
     xlab = "Finishing position",
     xlim = c(-10,10),
     col = "lightgrey",
     breaks = 50)
abline(v = diff_obs, col = "blue", lwd = 3, lty = "dotted")
text(diff_obs - 0.2, 1500 , paste("Actual Diff in Means =", round(diff_obs,2)), srt = 90)

```

We compared Fernando Alonso's Qualifying vs Race results at Ferrari and McLaren. In the left plot Ferrari Era, the points are densely clustered in the bottom-left corner, suggesting his frequent ability to gain positions. It also shows a positive correlation between race start position and end position. In the right plot the McLaren era, the distribution is more spread out and shifts significantly to the upper right corner. This suggests the car's higher variability, unpredictability issue. There are also more points above the dashed line. We can infer that the car's technical limitations was causing the poorer performance, starting in the midfield and finished worse.  


```{r echo=FALSE}
f1_alonso <- f1_data[f1_data$driverRef == "alonso", ]

f1_alonso_ferrari <- f1_alonso_test %>% filter(constructorRef == "ferrari")
f1_alonso_mclaren <- f1_alonso_test %>% filter(constructorRef == "mclaren")

par(mfrow = c(1, 2))
# ggplot(f1_alonso_ferrari, aes( x = grid, y = positionOrder)) +
#   geom_jitter(color = "darkred", alpha = 0.6, size = 4) +
#   geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "grey50") +
#   # geom_smooth(method = "lm", color = "red", se = FALSE, size = 0.5) +
#   scale_x_continuous(breaks = seq(0, 20, 5)) +
#   scale_y_continuous(breaks = seq(0, 20, 5)) +
#   labs(title = "Alonso at Ferrari",
#        subtitle = "Points below the dashed line indicate positions gained during the race",
#        x = "Starting Grid Position",
#        y = "Finishing Position") +
#     theme_linedraw()
# 
# ggplot(f1_alonso_mclaren, aes( x = grid, y = positionOrder)) +
#   geom_jitter(color = "orange", alpha = 0.6, size = 4) +
#   geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "grey50") +
#   # geom_smooth(method = "lm", color = "red", se = FALSE, size = 0.5) +
#   scale_x_continuous(breaks = seq(0, 20, 5)) +
#   scale_y_continuous(breaks = seq(0, 20, 5)) +
#   labs(title = "Alonso at McLaren",
#        subtitle = "Points below the dashed line indicate positions gained during the race",
#        x = "Starting Grid Position",
#        y = "Finishing Position") +
#     theme_linedraw()


plot(jitter(f1_alonso_ferrari$grid, amount = 0.2), 
     jitter(f1_alonso_ferrari$positionOrder, amount = 0.2),
     main = "Alonso at Ferrari",
     sub = "Consistent Top Finishes", 
     xlab = "Starting Grid Position",
     ylab = "Finishing Position",
     xlim = c(0, 22), 
     ylim = c(0, 22),
     pch = 19,
     col = adjustcolor("darkred", alpha.f = 0.6), 
     las = 1)
abline(a = 0, b = 1, lty = 2, col = "grey50", lwd = 2)
abline(lm(positionOrder ~ grid, data = f1_alonso_ferrari), col = "black", lwd = 2)
grid() 


# --- PLOT 2: ALONSO AT MCLAREN ---
plot(jitter(f1_alonso_mclaren$grid, amount = 0.2), 
     jitter(f1_alonso_mclaren$positionOrder, amount = 0.2),
     main = "Alonso at McLaren",
     sub = "High Variance & Struggles",
     xlab = "Starting Grid Position",
     ylab = "",                           # No Y label to save space
     xlim = c(0, 22),
     ylim = c(0, 22),
     pch = 19,
     col = adjustcolor("orange", alpha.f = 0.6),
     las = 1)
abline(a = 0, b = 1, lty = 2, col = "grey50", lwd = 2)
abline(lm(positionOrder ~ grid, data = f1_alonso_mclaren), col = "black", lwd = 2)
grid()


# abline(lm(positionOrder ~ grid, data = f1_alonso_ferrari), col = "red")

```


we calculated the Pearson correlation coefficient and fitted a simple linear regression model.

The diagnostic plots (Residuals vs. Fitted) show no severe violations of linearity, confirming that starting position is a robust, though not exclusive, predictor of race results.

```{r}

# cor_est <- cor(f1_clean$grid, f1_clean$positionOrder)
# print(paste("Pearson Correlation:", round(cor_est, 3)))

# f1_clean_sub %>%
#   filter(driverRef %in% top_teams)

plot(jitter(grid, factor = 2) ~ jitter(positionOrder, factor = 2), data = f1_alonso, main = "", 
     xlab = "", ylab = "", pch = 19, col = "blue")
abline(lm(grid ~ positionOrder, data = f1_alonso), col = "red")


lm_alonso <- lm(grid ~ positionOrder, data = f1_alonso)
summary(lm_alonso)
# 
# r <- rstudent(lm_alonso)
# f <- fitted(lm_alonso)
# 
# plot(r ~ f)

source("https://raw.githubusercontent.com/jreuning/sds230_files/refs/heads/main/regJDRS.txt")
myResPlots(lm_alonso, label = "")


# 
# plot(jitter(fastestLapSpeed) ~ jitter(age), data = f1_clean_hamiltom, main = "", 
#      xlab = "", ylab = "", pch = 19, col = "blue")
# abline(lm(fastestLapSpeed ~ age, data = f1_clean_hamiltom), col = "red")
# 
# 
# plot(jitter(grid) ~ jitter(age), data = f1_clean_hamiltom, main = "", 
#      xlab = "", ylab = "", pch = 19, col = "blue")
# abline(lm(grid ~ age, data = f1_clean_hamiltom), col = "red")

```

# üèÅ Constructor Rival
#### Ferrari vs McLaren vs Mercedes vs Red Bull

We wanted to look at how fastest lap speeds differed between the top four constructors (Merceds, Red Bull, Mclaren, Ferrari).

```{r, echo = FALSE}

f1_topCnstr <- f1_clean[f1_clean$constructorRef == "mercedes" | f1_clean$constructorRef == "red_bull" | f1_clean$constructorRef == "mclaren" | f1_clean$constructorRef == "ferrari", c("driverRef", "constructorRef","fastestLapSpeed")]

#remove any unused levels
f1_topCnstr$constructorRef <- droplevels(f1_topCnstr$constructorRef)

#remove any rows with NA for fastestLapSpeed
f1_topCnstr <- f1_topCnstr[is.na(f1_topCnstr$fastestLapSpeed) == FALSE, ]


#gets list of mean fastest lap speed for each constructor
meanscn <- by(f1_topCnstr$fastestLapSpeed, f1_topCnstr$constructorRef, mean)
boxplot(f1_topCnstr$fastestLapSpeed ~ f1_topCnstr$constructorRef, col = c(colors()[465:469]), xlab = "Constructor", ylab = "Fastest Lap Speed (kph)", main = "Boxplots of Fastest Lap Speed for Different Constructors", cex.axis = .75, las = 1)
points(c(1:4), meanscn, col = "red", pch = 19)
text(x = 1:4, y = meanscn + 10, labels = paste0("Mean = ", round(meanscn, 2)), col    = "black")


```

After looking at this data, we were curious if the differences between the mean fastest lap speed of each group were significant. To do this, we need to perform one way ANOVA, but first we need to look and see if it appears that the basic assumptions of ANOVA are met:
1) All data is taken from populations which have normal distributions
2) These normal distributions may have different means but have
identical standard deviationÔÅ≥ : i.e., variance is constant in all groups
3) All observations are independent

```{r}

#generating histograms
for (i in unique(f1_topCnstr$constructorRef)) {
  hist(f1_topCnstr[f1_topCnstr$constructorRef == i, "fastestLapSpeed"], xlab = i)
}

#generating normal quantile plots
for (i in unique(f1_topCnstr$constructorRef)) {
  qqp(f1_clean[f1_topCnstr$constructorRef == i, "fastestLapSpeed"], xlab = i)
}

#comparing standard deviations (goal is ratio is ~2)
sdscn <- by(f1_topCnstr$fastestLapSpeed, f1_topCnstr$constructorRef, sd)
max(sdscn)/min(sdscn) #1.025 BASICALLY EQUAL VARIANCE!!!




```


It looks like the assumptions are met: (normality of data, constant variance, independence)


```{r}


aovcn <- aov(f1_topCnstr$fastestLapSpeed ~ f1_topCnstr$constructorRef)
summary(aovcn) #degrees of freedom is 10, which is expected

#making a linear model, not sure if we actually do this
modcn <- lm(f1_topCnstr$fastestLapSpeed ~ f1_topCnstr$constructorRef -1)
summary(modcn)

library(plotrix)

CIscn <- confint(modcn)
round(CIscn, 2)
coefscn <- coef(modcn)
coefscn

par(mar=c(5,8,4,2))
plotCI(coefscn, 1:(length(coefscn)), ui = CIscn[,2], li = CIscn[,1], axes = FALSE,
err = "x", ylab = "", xlab = "Mean (and 95% CI)", main = "Mean and CI's for
\nFastest Lap Speed by Constructor", lwd = 2, col = "blue")
axis(side = 1)
axis(side = 2, at = 1:(length(coefscn)), label=levels(as.factor(f1_topCnstr$constructorRef)),las=2)

## Don't conclude anything from confidence intervals overlapping

#USING multiple comparisons to see which means are different 
pairwise.t.test(f1_topCnstr$fastestLapSpeed, f1_topCnstr$constructorRef) 
#nothing is significant

#same as above
TukeyHSD(aovcn)
par(mar = c(5, 11, 4, 1))
plot(TukeyHSD(aovcn), las = 1)



#RESIDUAL PLOTS!!!
library(car)

rsmfcn <- rstudent(aovcn)
fitvcn <- fitted(aovcn)
plot(rsmfcn ~ fitvcn,
pch = 19,
col = colors()[36],
main = "Studentized Residuals vs Fits, \nlog(Percent Return) by Movie
Genre",
ylim = c(-3.5, 3.5),
xlab = "Fits",
ylab = "Studentized Residuals")
abline(h = c(-2, 2), lty = 2, col = "forestgreen", lwd = 3)
abline(h = c(-3, 3), lty = 3, col = "goldenrod1", lwd = 3)
abline(h = 0, lty = 5 , col = "black", lwd = 3)

qqPlot(rsmfcn,
pch = 19,
main = "NQ Plot of Studentized Residuals, \nMean Finishing Position by Constructor Nationality")



###################### Assumes samples are taken from a normal distribution but have unequal variances
#Bartlett test 
bartlett.test(f1_topCnstr$fastestLapSpeed, f1_topCnstr$constructorRef)
#p-value = .9179 so the variances are the same (bc no evidence of difference)


#Levene's test No assumptions about normality
leveneTest(f1_topCnstr$fastestLapSpeed, f1_topCnstr$constructorRef)
#p-value = .9886 so the variances are the same (bc no evidence of difference)




###Welch's ANOVA (unequal variances but normally distributed data in each group) --> should just use regular anova bc qual variance
oneway.test(f1_topCnstr$fastestLapSpeed ~ f1_topCnstr$constructorRef, data = f1_topCnstr)
#we fail to reject the null hypothesis so there is no evidence of difference between means


##kruskal wallis (no assumptions about variance or normality)
kruskal.test(f1_topCnstr$fastestLapSpeed ~ f1_topCnstr$constructorRef, data = f1_topCnstr)
#once again fail to reject null hypothesis




```



# üèÅ Race Result Model

```{r echo=FALSE}


#make a subset with top drivers with over 200 data points
f1_topDrive <- f1_clean %>%
  filter(driverRef %in% c("hamilton", "alonso", "max_verstappen", "vettel", "sainz"))
#f1_topDrive <- f1_clean[f1_clean$driverRef == "hamilton" | f1_clean$driverRef == "alonso" | f1_clean$driverRef == #"max_verstappen" | f1_clean$driverRef == "vettel" | f1_clean$driverRef == "sainz", ]


# REMEMBER NO YEAR IS INCLUDED BC OF PERFECT COLLINEARITY WITH AGE
lm1 <- lm(positionOrder ~ grid + constructorRef + fastestLapSpeed + fastestLapTime + duration + age + fastestLap + driverRef, data = f1_topDrive)
summary(lm1)

#drop duration
lm2 <- lm(positionOrder ~ grid + constructorRef + fastestLapSpeed + fastestLapTime + age + fastestLap + driverRef, data = f1_topDrive)
summary(lm2)

#drop age
lm3 <- lm(positionOrder ~ grid + constructorRef + fastestLapSpeed + fastestLapTime + fastestLap + driverRef, data = f1_topDrive)
summary(lm3)
#TALK ABOUT FASTEST LAP!!! (faster lap later in the race = better finishing positions (negative coeffcient))

Anova(lm3, type = "III")


rsmf20 <- rstudent(lm3)
fitv20 <- fitted(lm3)
plot(rsmf20 ~ fitv20,
pch = 19,
col = colors()[36],
main = "Studentized Residuals vs Fits, \nlog(finish position) predicted by grid + constructorRef + fastestLapSpeed + fastestLapTime + fastestLap + driverRef",
ylim = c(-3.5, 3.5),
xlab = "Fits",
ylab = "Studentized Residuals")
abline(h = c(-2, 2), lty = 2, col = "forestgreen", lwd = 3)
abline(h = c(-3, 3), lty = 3, col = "goldenrod1", lwd = 3)
abline(h = 0, lty = 5 , col = "black", lwd = 3)

qqPlot(rsmf20,
pch = 19,
main = "NQ Plot of Studentized Residuals, \nMean Finishing Position by grid + constructorRef + fastestLapSpeed + fastestLapTime + fastestLap + driverRef")


##############################################################################################################

#BOX COX

trans1 <- boxCox(lm1)
trans1
#Figure out what value of lambda (x) gives max value of log-liklihood (y)
trans1$x[which.max(trans1$y)]
#looks to be around .2, which we say is close enough to 0 so we do log


##############################################################################################################


#Do log now


# REMEMBER NO YEAR IS INCLUDED BC OF PERFECT COLLINEARITY WITH AGE
lm1lg <- lm(log(positionOrder) ~ grid + constructorRef + fastestLapSpeed + fastestLapTime + duration + age + fastestLap + driverRef, data = f1_topDrive)
summary(lm1lg)

#drop duration
lm2lg <- lm(log(positionOrder) ~ grid + constructorRef + fastestLapSpeed + fastestLapTime + age + fastestLap + driverRef, data = f1_topDrive)
summary(lm2lg)

#drop age
lm3lg <- lm(log(positionOrder) ~ grid + constructorRef + fastestLapSpeed + fastestLapTime + fastestLap + driverRef, data = f1_topDrive)
summary(lm3lg)
#TALK ABOUT FASTEST LAP!!! (faster lap later in the race = better finishing positions (negative coeffcient))


## overall test if our predictors are significant (they are!!!!!!!!!!!!!!!)
Anova(lm3lg, type = "III")


#residual plots
rsmf20lg <- rstudent(lm3lg)
fitv20lg <- fitted(lm3lg)
plot(rsmf20 ~ fitv20,
pch = 19,
col = colors()[36],
main = "Studentized Residuals vs Fits, \nlog(finish position) predicted by grid + constructorRef + fastestLapSpeed + fastestLapTime + fastestLap + driverRef",
ylim = c(-3.5, 3.5),
xlab = "Fits",
ylab = "Studentized Residuals")
abline(h = c(-2, 2), lty = 2, col = "forestgreen", lwd = 3)
abline(h = c(-3, 3), lty = 3, col = "goldenrod1", lwd = 3)
abline(h = 0, lty = 5 , col = "black", lwd = 3)

qqPlot(rsmf20lg,
pch = 19,
main = "NQ Plot of Studentized Residuals, \nMean Finishing Position by Constructor ")





```



# üèÅ A Closer Looks

In this section, we included histgrams and QQ plots for
- fastest lap speed
- driver's age
- fastest lap time
- mean pit stop time

```{r echo=FALSE}
par(mfrow = c(2, 2))
f1_clean_pit <- f1_clean %>% filter(duration <= 60)

hist(f1_clean$fastestLapSpeed,
     breaks = 20,
     col = "grey40", 
     border = "white",
     main = "Fastest Lap Speeds",
     xlab = "Speed (km/h)",
     las = 1) 

hist(f1_clean$age,
     breaks = 15,
     col = "grey40",
     border = "white",
     main = "Driver's Age",
     xlab = "Age (Years)",
     las = 1)

hist(f1_clean$fastestLapSeconds,
     breaks = 20,
     col = "grey40",
     border = "white",
     main = "Fastest Lap Times",
     xlab = "Time (seconds)",
     las = 1)

hist(f1_clean_pit$duration,
     breaks = 40, # More breaks to see the "two peaks" detail
     col = "grey40",
     border = "white",
     main = "Pit Stop Duration (<60s)",
     xlab = "Duration (seconds)",
     las = 1)

# hist(f1_brit_german$positionOrder[f1_brit_german$driver_nationality == "German"])

```


```{r echo=FALSE}

par(mfrow = c(2, 2))
qqPlot(f1_clean$fastestLapSpeed, 
       main = "QQ Plot: Fastest Lap Speed",
       ylab = "Speed (km/h)",
       col = "red", pch = 19, cex = 0.5)

qqPlot(f1_clean$age, 
       main = "QQ Plot: Driver's Age",
       ylab = "Age (Years",
       col = "red", pch = 19, cex = 0.5)

qqPlot(f1_clean$fastestLapSeconds, 
       main = "QQ Plot: Fastest Lap Time",
       ylab = "Time (Seconds)",
       col = "red", pch = 19, cex = 0.5)

qqPlot(log10(f1_clean_pit$duration), 
       main = "QQ Plot: QQ Plot: Pit Stop Duration (<60s)",
       ylab = "Duration (Seconds)",
       col = "red", pch = 19, cex = 0.5)

```









# üèÅ Summary

We have strong statistical evidence to suggest that Alonso‚Äôs average finishing position was significantly better at Ferrari than at McLaren.


# TBD

```{r echo=FALSE}

f1_country_most_driver <- f1_clean %>% filter(driver_nationality %in% c("British", "German", "Brazilian", "French", "Spanish"))

boxplot(positionOrder ~ driver_nationality, 
        data = f1_country_most_driver,
        main = "Finishing Positions by Country",
        xlab = "",
        ylab = "Finishing Position",
        las = 1)


boxplot(fastestLapSpeed ~ constructorRef, 
        data = f1_country_most_driver,
        main = "Fastest Lap Speed by Team",
        xlab = "",
        ylab = "Fastest Lap Speed (km/h)",
        las = 2)

```




###### 2) top drivers' quali vs race result
```{r echo=FALSE}

# --- Comparison of Top Drivers ---
top_drivers <- c("hamilton", "vettel", "alonso", "max_verstappen", "norris", "piastri", "leclerc", "russell", "sainz", "michael_schumacher")

f1_clean %>%
  filter(driverRef %in% top_drivers) %>%
  ggplot(aes(x = grid, y = positionOrder, color = driverRef)) +
  geom_point(alpha = 0.4) +
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "grey50") +
  # geom_smooth(method = "lm", color = "grey", se = FALSE, size = 0.5) +
  labs(title = "Qualifying vs. Race Result: Top Drivers Comparison",
       x = "Starting Grid Position",
       y = "Finishing Position") +
  theme_linedraw()  +
  facet_wrap(~driverRef) +
  theme(legend.position = "none", 
        strip.text = element_text(size = 12, face = "bold", color = "Black"),
        strip.background = element_rect(fill = "grey90"))

# cor_data <- f1_clean %>%
#   select(grid, positionOrder, fastestLapSpeed, points) %>%
#   drop_na()
# 
#   
# corrplot(cor(cor_data), method = "circle", type = "upper", 
#          title = "Correlation Matrix: Top Drivers (2010-2020)", 
#          mar = c(0,0,2,0), 
#          addCoef.col = "black") # Add numbers
```

###### 3) drivers' fastest lap time at Silverstone by year (2004-2024)

```{r echo=FALSE}

f1_britGP <- f1_data %>% filter(race_name == "British Grand Prix", year >= 2004) %>% 
  mutate(decade = floor(year / 10) * 10, decade_label = as.factor(paste0(decade, "s")))

scatterplot(fastestLapSeconds ~ year, 
        data = f1_britGP,
        main = "Fastest Lap Time by Country",
        xlab = "",
        ylab = "Fastest Lap Time (seconds)",
        ylim = c(60, 120),
        las = 1)
```

